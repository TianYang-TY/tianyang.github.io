<html>
<head>
    <meta charset="utf-8"/>
<meta name="description" content=""/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Freesurferæ“ä½œæ–‡æ¡£ | Yang&#39;s blog</title>

<link rel="shortcut icon" href="https://yangt.me/favicon.ico?v=1619768861129">

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://yangt.me/styles/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css">

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dart.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script>
<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->



    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <nav class="navbar navbar-expand-lg">
    <div class="navbar-brand">
        <img class="user-avatar" src="/images/avatar.png" alt="å¤´åƒ">
        <div class="site-name gt-c-content-color-first">
            Yang&#39;s blog
        </div>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
                <div class="nav-item">
                    
                        <a href="/" class="menu gt-a-link">
                            é¦–é¡µ
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/archives" class="menu gt-a-link">
                            å½’æ¡£
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/tags" class="menu gt-a-link">
                            æ ‡ç­¾
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/post/about" class="menu gt-a-link">
                            å…³äº
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="friends" class="menu gt-a-link">
                            å‹é“¾
                        </a>
                    
                </div>
            
        </div>
        <div style="text-align: center">
            <form id="gridea-search-form" style="position: relative" data-update="1619768861129" action="/search/index.html">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="æœç´¢æ–‡ç« " />
                <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
        </div>
    </div>
</nav>

    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    Freesurferæ“ä½œæ–‡æ¡£
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        Â· 2020-05-07 Â·
                    </time>
                    
                        <a href="https://yangt.me/tag/5JIqsTVwc/" class="post-tags">
                            # Linux
                        </a>
                    
                        <a href="https://yangt.me/tag/4tKidSvhRh/" class="post-tags">
                            # Ubuntu
                        </a>
                    
                        <a href="https://yangt.me/tag/nXH6UnePtt/" class="post-tags">
                            # Freesurfer
                        </a>
                    
                </div>
                <div class="post-content">
                    <p>æœ¬æ–‡æ¡£çš„æ“ä½œæµç¨‹åŸºäº Ububtu 18.04LTS ä»¥åŠ Freesurfer 6.0ï¼Œå®‰è£…è¿‡ç¨‹è®°å½•åœ¨å¦ä¸€ç¯‡æ–‡æ¡£ <em><a href="http://193824.xyz/post/zai-ubuntu1804lts-zhong-an-zhuang-freesurfer/">åœ¨ Ubuntu18.04LTS ä¸­å®‰è£… FreeSurfer</a></em> ä¸­ã€‚æœ¬æ–‡æ¡£æ“ä½œå…¨éƒ¨åœ¨ç»ˆç«¯ä¸­è¿›è¡Œï¼ŒFreesurfer çš„ GUI ä»…ç”¨ä½œæŸ¥çœ‹æ“ä½œç»“æœã€‚</p>
<!-- more -->
<blockquote>
<p>åˆ›å»ºäº2020-03-07</p>
<p>ä¿®æ”¹1ï¼š2020-03-08</p>
<p>â€‹    ä¿®æ­£SUBJECTS_DIRçš„è®¾ç½®æ–¹æ³•ä¸å•subjectå¤šå›¾åƒçš„æ–‡ä»¶å¤¹ç»“æ„</p>
<p>â€‹    ä¿®æ­£recon-allåœ¨å•subjectå¤šå›¾åƒæƒ…å†µä¸‹çš„å‘½ä»¤</p>
<p>ä¿®æ”¹2ï¼š2020-03-12</p>
<p>â€‹    åˆ é™¤ä¿®æ”¹1ä¸­å¢åŠ çš„å•subjectå¤šå›¾åƒæƒ…å†µ</p>
<p>â€‹    æ–°å¢å¤šå›¾åƒçš„å¤šçº¿ç¨‹å¤„ç†å†…å®¹</p>
<p>ä¿®æ”¹3ï¼š2020-04-15</p>
<p>â€‹    æ–°å¢DICOMè½¬niiå†…å®¹</p>
<p>ä¿®æ”¹4ï¼š2020-04-17</p>
<p>â€‹    æ–°å¢æ‰¹å¤„ç†æå–ç»Ÿè®¡å­¦ç»“æœçš„å†…å®¹</p>
<p>ä¿®æ”¹5ï¼š2020-04-27</p>
<p>â€‹    æ–°å¢PETå¤„ç†å†…å®¹</p>
<p>ä¿®æ”¹6ï¼š2020-05-12</p>
<p>â€‹    åŠ å…¥PETåçš„æ‰¹å¤„ç†æµç¨‹</p>
<p>ä¿®æ”¹7ï¼š2020-07-23</p>
<p>â€‹    å¯¹PETåˆ†å‰²é™å®šçº¿ç¨‹æ•°é¿å…æŠ¥é”™<br>
è¡¥å……äº†ä¸€äº›åç»­æ­¥éª¤</p>
<p>ä¿®æ”¹8ï¼š2020-11-02<br>
æ–°å¢æµ·é©¬å­åŒºåŸŸåˆ†å‰²æµç¨‹</p>
</blockquote>
<h2 id="subjects_dir">SUBJECTS_DIR</h2>
<p>é¦–å…ˆéœ€è¦ç”¨æˆ·è‡ªå®šä¹‰ <code>SUBJECTS_DIR</code>ï¼Œä¸æ¨èä½¿ç”¨æ”¾åœ¨ Freesurfer å®‰è£…ç›®å½•ä¸‹çš„é»˜è®¤æ–‡ä»¶å¤¹ï¼Œè‡ªå®šä¹‰ <code>SUBJECTS_DIR</code> çš„å‘½ä»¤å¦‚ä¸‹ï¼š<strong>æ“ä½œä¸­ä¸¥æ ¼é¿å…ä¸­æ–‡è·¯å¾„çš„å‡ºç°ï¼ï¼ï¼</strong></p>
<pre><code class="language-bash"># è®¾ç½®åˆ°æ¡Œé¢ä¸Š
export SUBJECTS_DIR=/home/ç”¨æˆ·å/Desktop/Subjects
# å¿«é€Ÿè®¾ç½®ä¸ºå½“å‰æ–‡ä»¶å¤¹
export SUBJECTS_DIR=$(pwd)

# æŸ¥çœ‹å½“å‰SUBJECTS_DIR
echo $SUBJECTS_DIR
</code></pre>
<p>åœ¨ <code>SUBJECTS_DIR</code> ä¸‹ï¼Œå¯ä»¥ç›´æ¥æ”¾ç½® <code>sample-001.mgz, sample-002.mgz</code> ç­‰æ–‡ä»¶ã€‚ä¸‹æ–¹æ–‡ä»¶å¤¹ç»“æ„ä¸ºåˆ†å‰²å®Œæˆåçš„æ–‡ä»¶å¤¹ç»“æ„ï¼š</p>
<pre><code class="language-text">SUBJECTS_DIR
â”œâ”€â”€ sample-001
â”‚   â”œâ”€â”€ label
â”‚   â”œâ”€â”€ mri
â”‚   â”‚   â”œâ”€â”€ orig
â”‚   â”‚   â””â”€â”€ transforms
â”‚   â”‚       â””â”€â”€ bak
â”‚   â”œâ”€â”€ scripts
â”‚   â”œâ”€â”€ stats
â”‚   â”œâ”€â”€ surf
â”‚   â”œâ”€â”€ tmp
â”‚   â”œâ”€â”€ touch
â”‚   â””â”€â”€ trash
â””â”€â”€ sample-002
    â”œâ”€â”€...
</code></pre>
<h2 id="recon-all">recon-all</h2>
<p><code>recon-all</code> ä¸º Freesurfer çš„æ ¸å¿ƒå‘½ä»¤ï¼Œä½¿ç”¨å‘½ä»¤ <code>recon-all --help</code> å¯ä»¥æŸ¥çœ‹è¯¦ç»†å¸®åŠ©ã€‚åœ¨æ“ä½œæ—¶å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ‡æ¢åˆ° <code>SUBJECTS_DIR</code> ä¸‹å¹¶æ‰§è¡Œ <code>recon-all</code>ï¼Œå¦‚æœéœ€è¦åŒæ—¶å¤„ç†å¤šä¸ªå›¾åƒï¼Œå¯ä»¥ä½¿ç”¨åé¢æåˆ°çš„ <a href="#parallel">Parallel</a>ï¼›å¦‚æœéœ€è¦å¤„ç†æ–‡ä»¶å¤¹å½¢å¼çš„ DICOM å›¾åƒï¼Œå¯å…ˆç”¨ <a href="#dcm2niix">dcm2niix</a> è½¬æ¢æˆ nii æ ¼å¼ã€‚</p>
<pre><code class="language-bash">cd $SUBJECTS_DIR
# bert æ˜¯å¯è‡ªå·±è®¾ç½®çš„ subject åå­—
recon-all -s bert -i sample-001.mgz -all
</code></pre>
<p>ä¸Šé¢çš„å‘½ä»¤æˆåŠŸæ‰§è¡Œåä¼šæŒç»­æ•°ä¸ªå°æ—¶ï¼Œå¤„ç†ç»“æœä¼šåˆ†ç±»å­˜æ”¾åœ¨ä¸Šä¸€éƒ¨åˆ†åˆ—å‡ºçš„æ–‡ä»¶å¤¹ç»“æ„ä¸­ã€‚</p>
<h2 id="freeview">freeview</h2>
<p>åœ¨ç»ˆç«¯ä¸­è¾“å…¥ <code>freeview</code> è¿›å…¥ GUIï¼Œç„¶åé€šè¿‡ <code>File - Load Volume</code> åŠ è½½ <code>mri -&gt; T1.mgz / aseg.mgz / wm.mgz / brainmask.mgz</code>ï¼Œ<code>aseg.mgz</code>æ˜¯ç°è´¨ç™½è´¨ç­‰è§£æ„çš„åˆ†å‰²ç»“æœï¼Œå¯ä»¥é€‰æ‹© Color map ä¸º Lookup Table å¹¶è°ƒä½é€æ˜åº¦è¿›è¡Œè§‚å¯Ÿã€‚</p>
<p>recon-allçš„ç»“æœä¸­è¿˜åŒ…å«äº†æ›²é¢ä¿¡æ¯ï¼Œä½¿ç”¨ <code>File - Load Surface</code> åŠ è½½ <code>surf -&gt; lh.pial / lh.white / lh.inflated</code> ä»¥åŠå¯¹åº”çš„å³è„‘æ–‡ä»¶ <code>surf -&gt; rh.pial / rh.white / rh.inflated</code>ã€‚</p>
<p>ä¸‹é¢çš„å‘½ä»¤è¡Œæ“ä½œä¸ä¸Šé¢çš„ç»“æœå®Œå…¨ç›¸åŒï¼Œæ— éœ€é‡å¤æ“ä½œï¼š</p>
<pre><code class="language-bash">$&gt; freeview -v \
    bert/mri/T1.mgz \
    bert/mri/wm.mgz \
    bert/mri/brainmask.mgz \
    bert/mri/aseg.mgz:colormap=lut:opacity=0.2 \
    -f \
    bert/surf/lh.white:edgecolor=blue \
    bert/surf/lh.pial:edgecolor=red \
    bert/surf/rh.white:edgecolor=blue \
    bert/surf/rh.pial:edgecolor=red
</code></pre>
<h2 id="stats">stats</h2>
<p>Freesurferçš„ <code>recon-all</code> å‘½ä»¤å·²ç»å¤„ç†çš„MRæ•°æ®çš„ä½“ç§¯ä»¥åŠçš®å±‚åšåº¦ä¿¡æ¯ï¼Œä½¿ç”¨ <code>asegstats2table, aparcstats2table</code> ä¸¤ä¸ªå‘½ä»¤å¯ä»¥åˆ†åˆ«æå–å‡ºã€‚ä½“ç§¯ä¸çš®å±‚åšåº¦ç»“æœå‡æ˜¯æŒ‰ç…§å·²ç»åˆ†å‰²å¥½çš„è„‘åŒºè¿›è¡Œç»Ÿè®¡ï¼Œçš®å±‚åšåº¦åªèƒ½å¯¹å·¦è„‘å’Œå³è„‘åˆ†åˆ«è¾“å‡ºã€‚å¦å¤–ï¼Œè¿™ä¸¤ä¸ªå‘½ä»¤ä»…èƒ½è¾“å‡ºtxtæ ¼å¼æ–‡æ¡£ï¼ŒæŸ¥çœ‹æ—¶éœ€è¦ä½¿ç”¨excelè¿›è¡Œè½¬æ¢ã€‚ä½¿ç”¨å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre><code class="language-bash"># https://surfer.nmr.mgh.harvard.edu/fswiki/asegstats2table
asegstats2table --subjects bert --common-segs --meas volume --stats=aseg.stats --table=segststs.txt

# https://surfer.nmr.mgh.harvard.edu/fswiki/aparcstats2table
# aparcstats2table éœ€è¦åˆ†åˆ«æå–å·¦å³è„‘çš„ç»“æœ
aparcstats2table --subjects bert --hemi lh --meas thickness --parc=aparc --tablefile=aparc.txt
aparcstats2table --subjects bert --hemi rh --meas thickness --parc=aparc --tablefile=aparc.txt
</code></pre>
<h2 id="span-idparallelparallelspan"><span id="parallel">Parallel</span></h2>
<p>Freesurfer æœ¬èº«æ— æ³•åŒæ—¶å¯¹å¤šä¸ªå›¾åƒï¼ˆå¤šä¸ª subjects ï¼‰è¿›è¡Œè®¡ç®—ï¼Œä¸ºäº†å……åˆ†åˆ©ç”¨ç”µè„‘çš„å¤šæ ¸æ€§èƒ½èŠ‚çœè®¡ç®—æ—¶é—´ï¼Œéœ€å€ŸåŠ©ä¸€ä¸ªå¤šçº¿ç¨‹å·¥å…·ï¼Œåä¸º GNU Parallelã€‚Parallel åœ¨ Ubuntuä¸‹å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>sudo apt-get install parallel</code> è¿›è¡Œå®‰è£…ã€‚å¤šçº¿ç¨‹è¿›è¡Œ recon-all çš„å‘½ä»¤å¦‚ä¸‹ï¼Œä½¿ç”¨æ­¤æ–¹æ³•ä¼šå°†æ¯ä¸ªå›¾åƒçš„æ–‡ä»¶åä½œä¸ºåˆ†å‰²è¯¥å›¾åƒæ—¶çš„subjectåå­—ã€‚æ‰§è¡Œæ­¤å‘½ä»¤æ—¶å¯èƒ½æ²¡æœ‰ä¿¡æ¯åœ¨ç»ˆç«¯è¾“å‡ºï¼Œæ‰§è¡Œå®Œæˆåä¼šä¸€æ¬¡æ€§è¾“å‡ºï¼Œå¦‚éœ€æŸ¥çœ‹è¿›è¡ŒçŠ¶æ€ï¼Œå¯ä»¥åˆ° <code>./scripts/recon-all.log</code> æŸ¥çœ‹ recon-all æ—¥å¿—.</p>
<pre><code class="language-bash"># mgz ä¸ºåç¼€ï¼Œéœ€è¦æŒ‡å®šå‚ä¸ CPU å‚ä¸è®¡ç®—çš„æ ¸å¿ƒæ•°åˆ™åœ¨ parallel ååŠ ï¼š--jobs æ ¸å¿ƒæ•°
ls *.mgz | parallel recon-all â€“s {.} â€“i {} â€“all

# ç»Ÿè®¡æ•°æ®æå–ä¹Ÿå¯ä»¥ä½¿ç”¨ Parallel
ls *.nii | parallel asegstats2table --subjects {.} --common-segs --meas volume --stats=aseg.stats --table=segststs_{.}.txt
ls *.nii | parallel aparcstats2table --subjects {.} --hemi lh --meas thickness --parc=aparc --tablefile=aparc_{.}_lh.txt
ls *.nii | parallel aparcstats2table --subjects {.} --hemi rh --meas thickness --parc=aparc --tablefile=aparc_{.}_rh.txt
</code></pre>
<p>å¯¹äºä¸Šè¿° Parallel å¯¼å‡ºçš„ä¸€ç³»åˆ—ç»Ÿè®¡txtæ–‡ä»¶ï¼Œæˆ‘ç¼–å†™äº† python ç¨‹åºè½¬æ¢æˆæ›´æ˜“è¯»çš„ csv æ–‡ä»¶ï¼Œå°†ä¸‹é¢çš„æ–‡ä»¶ä¿å­˜ä¸º <code>txt2csv.py</code> ç„¶åæ”¾åœ¨å½“å‰çš„ <code>SUBJECTS_DIR</code> ä¸‹ï¼Œåœ¨ç»ˆç«¯ä¸­æ‰§è¡Œ <code>python txt2csv.py</code> å³å¯è¿›è¡Œè½¬æ¢ã€‚</p>
<pre><code class="language-python">import csv
import os


def txt2csv(inputfile, outputfile):
    datacsv = open(outputfile, 'w')
    csvwriter = csv.writer(datacsv, dialect=(&quot;excel&quot;))
    mainfileH = open(inputfile, 'rb')
    for line in mainfileH.readlines():
        # print &quot;Debug: &quot; + line.replace('\n', '')
        csvwriter.writerow([a for a in line.decode().split('\t')])
    datacsv.close()
    mainfileH.close()


if __name__ == &quot;__main__&quot;:
    txt_list = [
        x for x in os.listdir('.')
        if os.path.isfile(x) and os.path.splitext(x)[1] == '.txt'
    ]
    for txt in txt_list:
        outputfile = txt.split('txt')[0] + 'csv'
        txt2csv(txt, outputfile)

</code></pre>
<h2 id="span-iddcm2niixdcm2niixspan"><span id="dcm2niix">dcm2niix</span></h2>
<p>recon-all å‘½ä»¤æ— æ³•å¯¹æ–‡ä»¶å¤¹å½¢å¼çš„ DICOM å›¾åƒç›´æ¥è¿›è¡Œå¤„ç†ï¼Œå€Ÿç”¨ <a href="https://github.com/rordenlab/dcm2niix">dcm2niix</a> åº“ä»¥åŠ parallel å¯ä»¥è¿›è¡Œæ‰¹é‡è½¬æ¢ã€‚dcm2niix é»˜è®¤å°†è½¬æ¢ç»“æœæ”¾åˆ°åŸ DICOM æ–‡ä»¶å¤¹å†…ï¼Œä¸æ–¹ä¾¿åç»­å¤„ç†ï¼Œæ‰€ä»¥ç”¨è®¾ç½® <code>-o</code> å‚æ•°æŒ‡å®šè¾“å‡ºæ–‡ä»¶å¤¹ã€‚</p>
<pre><code class="language-bash"># å®‰è£…
sudo apt-get install pigz dcm2niix

# ä½¿ç”¨
# å°†å¤šä¸ª DICOM æ–‡ä»¶å¤¹æ”¾åˆ°åŒä¸€ç›®å½•ä¸‹ï¼Œå¹¶é¿å…æœ‰å…¶ä»–é DICOM æ–‡ä»¶
ls | parallel dcm2niix -o ç›®æ ‡è¾“å‡ºæ–‡ä»¶å¤¹ {}
</code></pre>
<h2 id="petsurfer"><a href="https://surfer.nmr.mgh.harvard.edu/fswiki/PetSurfer">PETSurfer</a></h2>
<p>PETSurfer æ˜¯ Freesurfer 6 ä¸­å¼•å…¥çš„æ–°åŠŸèƒ½ï¼ŒåŒ…å«éƒ¨åˆ†å®¹ç§¯æ ¡æ­£ä»¥åŠåŠ›å­¦å»ºæ¨¡ç­‰åŠŸèƒ½ã€‚</p>
<ol>
<li>
<p>åˆ›å»ºä¸€ä¸ªåˆ†å‰²</p>
<pre><code class="language-bash"># æ›¿æ¢ SUBJECT
gtmseg --s SUBJECT
</code></pre>
<p>æ­¤æ­¥æ“ä½œä¼šä½¿ç”¨ç”Ÿæˆä¸€ä¸ªé«˜ç²¾åº¦çš„åˆ†å‰²ç»“æœ <code>SUBJECT/mri/gtmseg.mgz</code> ï¼Œä½¿ç”¨åˆ°åŸæ¥çš„ <code>ageg.mgz</code> æä¾›çš®å±‚ä¸‹ç»“æ„ï¼Œä½¿ç”¨ <code>?h.aparc.annot</code> æä¾›çš®å±‚ç»“æ„ï¼Œè¿˜å°†ä¼°è®¡ä¸€äº›é¢å¤–çš„è„‘ç»“æ„ã€‚</p>
</li>
<li>
<p>PET é…å‡†åˆ° MR</p>
<pre><code class="language-bash"># æ›¿æ¢ PET_IMAGE, templateåå­—ä¹Ÿå¯ä»¥ä¿®æ”¹
# PET_IMAGE ä¸ºPETè·¯å¾„/PETæ–‡ä»¶å
mri_coreg --s subject --mov PET_IMAGE --reg template.reg.lta
</code></pre>
<p>æ£€æŸ¥é…å‡†ç»“æœä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š</p>
<pre><code class="language-bash">tkregisterfv --mov PET_IMAGE --reg template.reg.lta --surfs
</code></pre>
</li>
<li>
<p>éƒ¨åˆ†å®¹ç§¯æ ¡æ­£</p>
<pre><code class="language-bash"># å…¶ä¸­ PET_IMAGE FWHM å‡éœ€è¦æ›¿æ¢
# PET_IMAGE ä¸ºPETè·¯å¾„/PETæ–‡ä»¶å
# å¦‚æœä¸éœ€è¦å‚è€ƒè„‘æ¡¥ä»£è°¢å€¼ï¼Œå¯ä»¥å†å‘½ä»¤ä¸­è¡¥å…… --no-rescale
# FWHM å–å†³äºè®¾å¤‡ï¼ŒåŒ»å¤§ä¸€é™¢ç”¨çš„2.8
mri_gtmpvc --i PET_IMAGE --reg template.reg.lta --psf 2.8 --seg gtmseg.mgz --default-seg-merge  --auto-mask PSF .01 --mgx .01 --o gtmpvc.output 
</code></pre>
</li>
</ol>
<pre><code>   
å®˜ç½‘å¯¹å„å‚æ•°çš„è§£é‡Šå¦‚ä¸‹ï¼š
   
   &gt;--psf FWHM is the full-width/half-max of the the point-spread function (PSF) of the scanner as measured in image space (also known as the burring function). The blurring function depends on the scanner and reconstruction method; here it is modeled as an isotropic Gaussian filter of the given FWHM. Eg, an HR+ is typically about 6mm. This parameter has nothing to do with applying smoothing. Set this to 0 to turn off PVC. If you don't know what to set this to, ask your PET physicist.
   &gt;--seg gtmseg.mgz is the segmentation created with gtmseg
   &gt;--default-seg-merge will merge several segmentations, eg, all the ventricular CSF segments will be merged into one ROI
   &gt;--auto-mask FWHM .01 will create a mask to exclude voxels from the analysis (saves time). Output volumes will be reduced to a bounding box around this mask (saves space)
   &gt;--mgx .01 Run Muller-Gartner analysis. 01 is the GM threshold. Only necessary if you want to do a voxel-wise analysis.
   &gt;--o gtmpvc.output This is the output folder.
</code></pre>
<p>æ­¤æ­¥ç”Ÿæˆäº†ä¸€ä¸ªæ–‡ä»¶ <code>./gtmpvc.output/gtm.stats</code> ï¼Œé‡Œé¢å­˜æ”¾äº†å„ä¸ª ROI çš„ä»£è°¢ä¿¡æ¯ï¼Œé˜…è¯»å‚è€ƒå¦‚ä¸‹å†…å®¹ï¼š</p>
<blockquote>
<p>9 17 Left-Hippocampus subcort_gm 473 174.083 1.406 0.1216</p>
<p>9 = ninth row<br>
17 = index for ROI<br>
Left-Hippocampus = name of ROI<br>
subcort_gm = tissue class<br>
473 = number of PET voxels in the ROI<br>
174 = variance reduction factor for ROI (based on GLM/SGTM)<br>
1.406 = PVC uptake of ROI relative to Pons<br>
0.1216 = resdiual varaince across voxels in the ROI</p>
</blockquote>
<h2 id="å¼•å…¥petåçš„æ‰¹å¤„ç†">å¼•å…¥PETåçš„æ‰¹å¤„ç†</h2>
<p>ç®€å•çš„PETæ‰¹å¤„ç†æ–¹æ³•éœ€è¦ä»è½¬DICOMå¼€å§‹è¿›è¡Œæ“ä½œã€‚é¦–å…ˆåˆ‡æ¢åˆ°åœ¨ç›®æ ‡ç›®å½•æ‰“å¼€ç»ˆç«¯å¹¶è®¾ç½®ä¸º<code>SUBJECTS_DIR</code> ï¼Œå¹¶å»ºç«‹ä¸¤ä¸ªå­˜æ”¾DICOMçš„æ–‡ä»¶å¤¹ï¼Œç„¶ååˆ†åˆ«è®²MRå’ŒPETå›¾åƒå­˜è¿›å»ï¼š</p>
<pre><code class="language-bash">export SUBJECTS_DIR=$(pwd)
# åˆ†åˆ«ä¸ºPETå›¾åƒå’ŒMRå›¾åƒå»ºç«‹ä¸€ä¸ªåä¸ºPETå’ŒMRçš„æ–‡ä»¶å¤¹ï¼Œåˆ†éš”å¼€
mkdir MR
mkdir PET
</code></pre>
<p>ä¸‹é¢å¼€å§‹è½¬æ¢æ ¼å¼ï¼Œè½¬æ¢çš„niiä½¿ç”¨äººåå‘½åï¼Œ<strong>å¦‚æœæœ‰ç©ºæ ¼æˆ–è€…é‡å¤äººåéœ€è¦æ‰‹åŠ¨ä¿®æ­£</strong>ã€‚</p>
<pre><code class="language-bash"># åˆ‡æ¢åˆ°MRæ–‡ä»¶å¤¹ï¼Œè¾“å‡ºæ–‡ä»¶ç›´æ¥æ”¾åˆ° SUBJECTS_DIR
cd MR
ls | parallel dcm2niix -o $SUBJECTS_DIR -f %n -b n {}

# åˆ‡æ¢åˆ°PETæ–‡ä»¶å¤¹
cd ../PET
ls | parallel dcm2niix -o $(pwd) -f pet_%n -b n {}

# è¿”å› SUBJECTS_DIR
cd ..
</code></pre>
<p>ç„¶åå¯¹MRè¿›è¡Œåˆ†å‰²</p>
<pre><code class="language-bash">#æ­¤æ—¶ç›®å½•åº”è¯¥æ˜¯SUBJECTS_DIR
ls *.nii | parallel recon-all â€“s {.} â€“i {} â€“all
</code></pre>
<p>ç„¶åå¤„ç†PETï¼Œå„å‘½ä»¤å«ä¹‰è§ä¸Šä¸€èŠ‚ï¼š</p>
<pre><code class="language-bash">ls *.nii | parallel --jobs 4 gtmseg --s {.}

ls *.nii | parallel mri_coreg --s {.} --mov PET/pet_{} --reg {.}.reg.lta
# é…å‡†ç»“æœæ£€æŸ¥ä¸ä½¿ç”¨æ‰¹å¤„ç†

# å¦‚æœä¸éœ€è¦å‚è€ƒè„‘æ¡¥ä»£è°¢å€¼ï¼Œå¯ä»¥å†å‘½ä»¤ä¸­è¡¥å…… --no-rescale
# FWHM éœ€è¦æŒ‡å®šä¸€ä¸ªå€¼
ls *.nii | parallel --jobs 4 mri_gtmpvc --i PET/pet_{} --reg {.}.reg.lta --psf FWHM --seg gtmseg.mgz --default-seg-merge  --auto-mask PSF .01 --mgx .01 --o {.}_gtmpvc.output 
</code></pre>
<p>æå–recon-allçš„ç»Ÿè®¡ç»“æœ</p>
<pre><code class="language-bash">mkdir asegStats
ls *.nii | parallel asegstats2table --subjects {.} --common-segs --meas volume --stats=aseg.stats --table=./asegStats/{.}_segststs.txt

# https://surfer.nmr.mgh.harvard.edu/fswiki/aparcstats2table
# aparcstats2table éœ€è¦åˆ†åˆ«æå–å·¦å³è„‘çš„ç»“æœ
mkdir aparcStats
ls *.nii | parallel aparcstats2table --subjects {.} --hemi lh --meas thickness --parc=aparc --tablefile=./aparcStats/{.}_aparc_lh.txt
ls *.nii | parallel aparcstats2table --subjects {.} --hemi rh --meas thickness --parc=aparc --tablefile=./aparcStats/{.}_aparc_rh.txt
</code></pre>
<p>æå– gtmseg åŠå…¶ç»Ÿè®¡ç»“æœ</p>
<pre><code class="language-bash">mkdir gtmseg
ls *.nii | parallel cp ./{.}/mri/gtmseg.mgz ./gtmseg/{.}_gtmseg.mgz

mkdir gtmVolume
ls *.nii | parallel asegstats2table --subjects {.} --common-segs --meas volume --stats=gtmseg.stats --table=./gtmVolume/{.}_gtmVolume.txt
</code></pre>
<p>æå–PETå¤„ç†ç»“æœ gtm.stats.dat</p>
<pre><code class="language-bash">mkdir gtmStats
ls *.nii | parallel cp ./{.}_gtmpvc.output/gtm.stats.dat ./gtmStats/{.}.gtm.stats.dat
</code></pre>
<h2 id="æµ·é©¬å­åŒºåŸŸåˆ†å‰²"><a href="https://surfer.nmr.mgh.harvard.edu/fswiki/HippocampalSubfields">æµ·é©¬å­åŒºåŸŸåˆ†å‰²</a></h2>
<p>è¿›è¡Œæ­¤æ­¥éª¤çš„å‰ææ˜¯æ­£ç¡®å®‰è£…äº†matlab runtimeï¼Œç„¶ååªéœ€è¦æ‰§è¡Œ <code>recon-all</code> å‘½ä»¤</p>
<p>å¦‚æœæ˜¯ä¸€ä¸ªæ–°çš„å¾…åˆ†å‰²æ•°æ®ï¼Œéœ€è¦é‡æ–°å¼€å§‹ <code>recon-all</code> è¿‡ç¨‹</p>
<pre><code class="language-bash"> # bertå¯ä»¥è‡ªå®šä¹‰
 recon-all -all -s bert -hippocampal-subfields-T1
</code></pre>
<p>å¦‚æœä¹‹å‰è¿›è¡Œè¿‡ <code>recon-all</code> åˆ†å‰²ï¼Œåªéœ€è¦æ‰§è¡Œ</p>
<pre><code class="language-bash"># bertä¸ºåŸæ¥çš„subjectåç§°
recon-all -s bert -hippocampal-subfields-T1
</code></pre>
<p>åˆ†å‰²ç»“æœå­˜æ”¾åœ¨æ–‡ä»¶å¤¹ <code>$SUBJECTS_DIR/bert/mri/</code>ä¸­ï¼Œå¯ä»¥ä½¿ç”¨freeviewæŸ¥çœ‹åˆ†å‰²ç»“æœ</p>
<pre><code class="language-bash">cd ./bert/mri
freeview -v nu.mgz -v lh.hippoSfLabels-T1.v10.mgz:colormap=lut -v rh.hippoSfLabels-T1.v10.mgz:colormap=lut
</code></pre>
<p>æœ‰å…³åˆ†å‰²ç»“æœçš„ä»‹ç»ï¼Œfsæ–‡æ¡£åŸæ–‡å¦‚ä¸‹</p>
<blockquote>
<p>The output will consist of six files (three for each hemisphere) that can be found under the subject's mri directory (in this example, $SUBJECTS_DIR/bert/mri/):</p>
<p><em>[lr]h.hippoSfLabels-T1.v10.mgz</em>: they store the discrete segmentation volume (lh for the left hemisphere, rh for the right) at 0.333 mm resolution.</p>
<p><em>[lr]h.hippoSfLabels-T1.v10.FSvoxelSpace.mgz</em>: they store the discrete segmentation volume in the <a href="https://surfer.nmr.mgh.harvard.edu/fswiki/FreeSurfer">FreeSurfer</a> voxel space (normally 1mm isotropic, unless higher resolution data was used in recon-all with the flag -cm).</p>
<p><em>[lr]h.hippoSfVolumes-T1.v10.txt</em>: these text files store the estimated volumes of the subfields and of the whole hippocampi.</p>
<p>Note that [lr]h.hippoSfLabels-T1.v10.mgz covers only a patch around the hippocampus, at a higher resolution than the input image. The segmentation and the image are defined in the same physical coordinates, so you can visualize them simultaneously with (run from the subject's mri directory):</p>
<p>On the other hand [lr]h.hippoSfLabels-T1.v10.FSvoxelSpace.mgz lives in the same voxel space as the other <a href="https://surfer.nmr.mgh.harvard.edu/fswiki/FreeSurfer">FreeSurfer</a> volumes (e.g., orig.mgz, nu.mgz, aseg.mgz), so you can use it directly to produce masks for further analyses, but its resolution is lower than that of [lr]h.hippoSfLabels-T1.v10.mgz.</p>
</blockquote>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">ä¸‹ä¸€ç¯‡</div>
                <a href="https://yangt.me/post/install-freesurfer-on-ubuntu1804lts/" class="post-title gt-a-link">
                    åœ¨Ubuntu18.04LTSä¸­å®‰è£…FreeSurfer
                </a>
            </div>
        

        

        

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first">è‹Ÿåˆ©å›½å®¶ç”Ÿæ­»ä»¥ï¼Œå²‚å› ç¥¸ç¦é¿è¶‹ä¹‹ğŸ•¶</div>
    <div class="social-container">
        
            
        
            
        
            
        
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        Copyright &copy; 2019-<span id="footerYear">2019</span> Yang Tian. All rights reserved.
<script type="text/javascript">
document.getElementById('footerYear').innerHTML = new Date().getFullYear();
</script>
    </div>
    <div>
        Theme by <a href="https://imhanjie.com/" target="_blank">imhanjie</a>, Powered by <a
                href="https://github.com/getgridea/gridea" target="_blank">Gridea | <a href="https://yangt.me/atom.xml" target="_blank">RSS</a></a>
    </div>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>

    </div>
</div>
</body>
</html>
